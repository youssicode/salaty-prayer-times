//!
const jsonResult = [
    {
        business_status: "OPERATIONAL",
        geometry: {
            location: {
                lat: 34.2590261,
                lng: -5.9207879
            },
            viewport: {
                northeast: {
                    lat: 34.2603120802915,
                    lng: -5.919440469708497
                },
                southwest: {
                    lat: 34.2576141197085,
                    lng: -5.922138430291501
                }
            }
        },
        icon: "https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/worship_islam-71.png",
        icon_background_color: "#7B9EB0",
        icon_mask_base_uri: "https://maps.gstatic.com/mapfiles/place_api/icons/v2/worship_islam_pinlet",
        name: "مسجد البخاري",
        photos: [
            {
                height: 510,
                html_attributions: [
                    "<a href=\"https://maps.google.com/maps/contrib/111048904399841236316\">Abdelmajid Chikri</a>"
                ],
                photo_reference: "AfLeUgPB4sGehUytgfaDz0O1TafFHE1yP0_YljktYujYGrnx5eWocOedy7h-rsrJzbKwU6JazPOiJVPl4EVyXS41GZOwY0QCLt9FBf5f2Ev0CH5pb_w8ztQE54SY2oj8Y7nJ0UuKfPqH97SJF9gYIX5TPv6PlzbQeYwfD3yXjNZzkJspqa83",
                width: 765
            }
        ],
        place_id: "ChIJ4-etbGqboA0R3XAYo5GyoPU",
        plus_code: {
            compound_code: "735H+JM Sidi Slimane, Morocco",
            global_code: "8C6P735H+JM"
        },
        rating: 4.5,
        reference: "ChIJ4-etbGqboA0R3XAYo5GyoPU",
        scope: "GOOGLE",
        types: [
            "mosque",
            "place_of_worship",
            "point_of_interest",
            "establishment"
        ],
        user_ratings_total: 13,
        vicinity: "Mosquée Al Boukhari, Sidi Slimane"
    },
    {
        business_status: "OPERATIONAL",
        geometry: {
            location: {
                lat: 34.2589723,
                lng: -5.920735099999999
            },
            viewport: {
                northeast: {
                    lat: 34.2602847302915,
                    lng: -5.919387019708496
                },
                southwest: {
                    lat: 34.2575867697085,
                    lng: -5.9220849802915
                }
            }
        },
        icon: "https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/worship_islam-71.png",
        icon_background_color: "#7B9EB0",
        icon_mask_base_uri: "https://maps.gstatic.com/mapfiles/place_api/icons/v2/worship_islam_pinlet",
        name: "Sidi SLIMANE",
        opening_hours: {
            open_now: false
        },
        photos: [
            {
                height: 603,
                html_attributions: [
                    "<a href=\"https://maps.google.com/maps/contrib/114317993390001175187\">Free Fire Drunk Video For Live فري فاير (Lm)</a>"
                ],
                photo_reference: "AfLeUgPQiKJZER32GVzmWESYbXj8MVlT5g4Dcs0ru3Hubg4sp3TSvdGiZvfFoAedGgNSclKySfE4SjDnedTTDVkfVoMi9GnqcTmMIiYnOjGy1Yww84Y0OQDopKHUnkJLlNaIvIcMgYaYv0wk8ZdXTO7D7OAxLhi_JxsghSKTsYu2NbIiBUCv",
                width: 540
            }
        ],
        place_id: "ChIJK7bkmSmboA0RR3E7OHBsoXg",
        plus_code: {
            compound_code: "735H+HP Sidi Slimane, Morocco",
            global_code: "8C6P735H+HP"
        },
        rating: 4.2,
        reference: "ChIJK7bkmSmboA0RR3E7OHBsoXg",
        scope: "GOOGLE",
        types: [
            "mosque",
            "place_of_worship",
            "point_of_interest",
            "establishment"
        ],
        user_ratings_total: 5,
        vicinity: "Mosquée Al Boukhari, Sidi Slimane"
    },
    {
        business_status: "OPERATIONAL",
        geometry: {
            location: {
                lat: 34.2603636,
                lng: -5.919962499999999
            },
            viewport: {
                northeast: {
                    lat: 34.2617981302915,
                    lng: -5.918612319708497
                },
                southwest: {
                    lat: 34.2591001697085,
                    lng: -5.921310280291502
                }
            }
        },
        icon: "https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/worship_islam-71.png",
        icon_background_color: "#7B9EB0",
        icon_mask_base_uri: "https://maps.gstatic.com/mapfiles/place_api/icons/v2/worship_islam_pinlet",
        name: "مسجد النجاة",
        place_id: "ChIJbxREAGqboA0RBfbaBoDnBXU",
        plus_code: {
            compound_code: "736J+42 Sidi Slimane, Morocco",
            global_code: "8C6P736J+42"
        },
        rating: 4.5,
        reference: "ChIJbxREAGqboA0RBfbaBoDnBXU",
        scope: "GOOGLE",
        types: [
            "mosque",
            "place_of_worship",
            "point_of_interest",
            "establishment"
        ],
        user_ratings_total: 13,
        vicinity: "al-Najat mosquée, Sidi Slimane"
    },
    {
        business_status: "OPERATIONAL",
        geometry: {
            location: {
                lat: 34.2622181,
                lng: -5.923998699999999
            },
            viewport: {
                northeast: {
                    lat: 34.2635310802915,
                    lng: -5.922555569708497
                },
                southwest: {
                    lat: 34.2608331197085,
                    lng: -5.925253530291502
                }
            }
        },
        icon: "https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/worship_islam-71.png",
        icon_background_color: "#7B9EB0",
        icon_mask_base_uri: "https://maps.gstatic.com/mapfiles/place_api/icons/v2/worship_islam_pinlet",
        name: "مسجد الــمــرادســة",
        opening_hours: {
            open_now: true
        },
        place_id: "ChIJoXQnEGiboA0RbiQlnUQdL0U",
        reference: "ChIJoXQnEGiboA0RbiQlnUQdL0U",
        scope: "GOOGLE",
        types: [
            "mosque",
            "place_of_worship",
            "point_of_interest",
            "establishment"
        ],
        vicinity: "736G+VCJ, سيدي سليمان،"
    },
    {
        business_status: "OPERATIONAL",
        geometry: {
            location: {
                lat: 34.2622181,
                lng: -5.923998699999999
            },
            viewport: {
                northeast: {
                    lat: 34.2635310802915,
                    lng: -5.922555569708497
                },
                southwest: {
                    lat: 34.2608331197085,
                    lng: -5.925253530291502
                }
            }
        },
        icon: "https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/worship_islam-71.png",
        icon_background_color: "#7B9EB0",
        icon_mask_base_uri: "https://maps.gstatic.com/mapfiles/place_api/icons/v2/worship_islam_pinlet",
        name: "مسجد الصوالة سيدي العربي",
        place_id: "ChIJSYgDu4CboA0Rbyc_4zF9YFA",
        plus_code: {
            compound_code: "736G+VC Sidi Slimane, Morocco",
            global_code: "8C6P736G+VC"
        },
        reference: "ChIJSYgDu4CboA0Rbyc_4zF9YFA",
        scope: "GOOGLE",
        types: [
            "mosque",
            "place_of_worship",
            "point_of_interest",
            "establishment"
        ],
        vicinity: "جماعة القصيبية, Sidi Slimane"
    },
    {
        geometry: {
            location: {
                lat: 34.2554685,
                lng: -5.9219021
            },
            viewport: {
                northeast: {
                    lat: 34.25680080368769,
                    lng: -5.920598537755179
                },
                southwest: {
                    lat: 34.25410284310469,
                    lng: -5.923296498338184
                }
            }
        },
        icon: "https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/worship_islam-71.png",
        icon_background_color: "#7B9EB0",
        icon_mask_base_uri: "https://maps.gstatic.com/mapfiles/place_api/icons/v2/worship_islam_pinlet",
        name: "Mosquée Al Houda",
        place_id: "ChIJzZpe0GqboA0RaQlAu1zw3zE",
        reference: "ChIJzZpe0GqboA0RaQlAu1zw3zE",
        scope: "GOOGLE",
        types: [
            "mosque",
            "premise",
            "place_of_worship",
            "point_of_interest",
            "establishment"
        ],
        vicinity: "Sidi Slimane"
    },
    {
        business_status: "OPERATIONAL",
        geometry: {
            location: {
                lat: 34.2553767,
                lng: -5.921788399999998
            },
            viewport: {
                northeast: {
                    lat: 34.2567252302915,
                    lng: -5.920390819708497
                },
                southwest: {
                    lat: 34.2540272697085,
                    lng: -5.923088780291502
                }
            }
        },
        icon: "https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/worship_islam-71.png",
        icon_background_color: "#7B9EB0",
        icon_mask_base_uri: "https://maps.gstatic.com/mapfiles/place_api/icons/v2/worship_islam_pinlet",
        name: "Mosquée El-Houda",
        photos: [
            {
                height: 2448,
                html_attributions: [
                    "<a href=\"https://maps.google.com/maps/contrib/105234593558897399384\">Abdelmjid Boukaddour</a>"
                ],
                photo_reference: "AfLeUgMOEgF5zzmZD0igwgzdvUDWCU5fSy32pMfTPgjWuOw4XCbbmAxtCzB4JYpmUciS54KiNSJzuhd5D0zUROnWCOWq04b0yGm-Q_Jmp9X8sJcuRZ7eEkAoJ2vPWWPkPgzOr5Katf4r0RSqwKCZtUeHzNKI5IMrv4Ogy8Uim1EHzZkC7Yw",
                width: 3264
            }
        ],
        place_id: "ChIJQxo30GqboA0RZmjIqNn3Blk",
        rating: 3.9,
        reference: "ChIJQxo30GqboA0RZmjIqNn3Blk",
        scope: "GOOGLE",
        types: [
            "mosque",
            "place_of_worship",
            "point_of_interest",
            "establishment"
        ],
        user_ratings_total: 55,
        vicinity: "734H+574, Sidi Slimane"
    },
    {
        business_status: "OPERATIONAL",
        geometry: {
            location: {
                lat: 34.270435,
                lng: -5.9219003
            },
            viewport: {
                northeast: {
                    lat: 34.27178423029149,
                    lng: -5.920552019708498
                },
                southwest: {
                    lat: 34.2690862697085,
                    lng: -5.923249980291502
                }
            }
        },
        icon: "https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/worship_islam-71.png",
        icon_background_color: "#7B9EB0",
        icon_mask_base_uri: "https://maps.gstatic.com/mapfiles/place_api/icons/v2/worship_islam_pinlet",
        name: "Mosquée",
        place_id: "ChIJe5jM8gmboA0RbXBcfQAl9Lg",
        reference: "ChIJe5jM8gmboA0RbXBcfQAl9Lg",
        scope: "GOOGLE",
        types: [
            "mosque",
            "place_of_worship",
            "point_of_interest",
            "establishment"
        ],
        vicinity: "73CH+56H, R409, Sidi Slimane"
    }
]
//!
//? Imported Modules
//==================

import google_key from "./apiKeys.js"
import errorHandler from "./errorHandler.js"
import dom from "./domElements.js"


//? Functions
//===========

const renderNearbyMosquesList = async (coords) => {
    if (!coords) {
        const locationError = new Error("Location shoud be defined first.")
        locationError.code = 88
        errorHandler(locationError)
        return
    }
    // const mosquesList = await getNearbyMosques(coords)
    const mosquesList = jsonResult.slice(0, 10) //!
    if (mosquesList) {
        dom.nearbyMosquesSection.classList.add("nearbyMosquesBtnClicked")
        displayMosquesList(mosquesList, coords)
    }
}

async function getNearbyMosques(coords) {
    try {
        const options = {
            method: 'GET',
            url: `https://cors-anywhere.herokuapp.com/https://maps.googleapis.com/maps/api/place/nearbysearch/json?location=${coords.latitude},${coords.longitude}&type=mosque&key=${google_key}&rankby=distance`,
        };
        const response = await axios.request(options)
        // return the first 10 results as an array of 10 elements
        console.log("Google API Response:", response.data.results.slice(0, 10))
        return response.data.results.slice(0, 10)
    } catch (err) {
        errorHandler(err)
    }
}

const displayMosquesList = (mosquesList, currentCoordinates) => {
    const mosquesWrapper = `
    <div class="mosquesWrapper">
        <ul class="mosquesList">
        </ul>
    </div>
    `
    dom.nearbyMosquesSection.innerHTML += mosquesWrapper
    dom.nearbyMosquesListWrapper = document.querySelector(".mosquesList") // nearbyMosquesListWrapper will be undefined befor we add it to DOM tree
    for (let i = 0; i < mosquesList.length; i++) {
        // Calculate mosque's distance
        const currentLat = currentCoordinates.latitude
        const currentLong = currentCoordinates.longitude
        const mosqueLat = mosquesList[i].geometry.location.lat
        const mosqueLong = mosquesList[i].geometry.location.lng
        const distance = haversineCalcDistance([currentLat, currentLong], [mosqueLat, mosqueLong])
        //! const distance = haversineCalcDistance([34.2591485, -5.9221253], [mosqueLat, mosqueLong])
        // Render mosques' Cards
        const mosqueCard = `
        <li class="mosqueInformationsCard">
        <div class="mosqueInformationsCard__mosque-icon fa-solid fa-mosque"></div>
        <div class="mosqueInformationsCard__title">
            <h4 class="mosqueInformationsCard__title__mosque-name">${mosquesList[i].name}</h4>
            <p class="mosqueInformationsCard__title__city">Sidi Slimane</p>
        </div>
        <div class="mosqueInformationsCard__distanceWrapper">
            <div class="mosqueInformationsCard__distanceWrapper__direction-icon fa-solid fa-diamond-turn-right"></div>
            <p class="mosqueInformationsCard__distanceWrapper__distance">${distance} meters</p>
        </div>
        </li>
        `
        dom.nearbyMosquesListWrapper.innerHTML += mosqueCard
    }
    const mosquesMap = `
    <aside class="mosquesMap">
        <img class="mosquesLocatedOnMap" src="./src/images/mosque-agdal-location.png" alt="listed-mosques-located-on-map">
    </aside>
    `
    dom.mosquesWrapper = document.querySelector(".mosquesWrapper") // mosquesWrapper will be undefined befor we add it to DOM tree
    dom.mosquesWrapper.innerHTML += mosquesMap
}

// Calculate the distance between to positions using "Heversine Formula"
const haversineCalcDistance = ([lat1, long1], [lat2, long2]) => {
    const toRadian = angle => angle * (Math.PI / 180);
    const distanceAB = (a, b) => (a - b) * (Math.PI / 180);
    const earth_radius_km = 6371;

    const dLat = distanceAB(lat2, lat1);
    const dLon = distanceAB(long2, long1);
    // convert latitudes to Radian
    lat1 = toRadian(lat1);
    lat2 = toRadian(lat2);

    // Haversine Formula
    const a = Math.pow(Math.sin(dLat / 2), 2) + Math.pow(Math.sin(dLon / 2), 2) * Math.cos(lat1) * Math.cos(lat2);
    const c = 2 * Math.asin(Math.sqrt(a));

    let finalDistance = earth_radius_km * c;

    return Math.round(finalDistance * 1000); // in meters
};

export default renderNearbyMosquesList